{% extends "base.html" %}

{% block head %}
<style>
    :root {
        --gradient-start: var(--primary-color);
        --gradient-end: #000000;
        --card-shadow: 0 10px 20px rgba(0,0,0,0.1);
        --transition-speed: 0.3s;
    }

    .analyzer-hero {
        background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        padding: 6rem 0;
        color: var(--text-light);
        margin-bottom: 4rem;
        position: relative;
        overflow: hidden;
    }

    .analyzer-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('/static/images/3409297.jpg') no-repeat center center;
        background-size: cover;
        opacity: 0.1;
        mix-blend-mode: overlay;
    }

    .analyzer-hero h1 {
        font-size: 3.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        margin-bottom: 2rem;
    }

    .feature-box {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        transition: all var(--transition-speed) ease;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .feature-box:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.15);
    }

    .feature-icon {
        font-size: 2.5rem;
        color: var(--gradient-start);
        margin-bottom: 1.5rem;
        transition: transform var(--transition-speed) ease;
    }

    .feature-box:hover .feature-icon {
        transform: scale(1.1);
    }

    .analyzer-form-wrapper {
        max-width: 800px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
        padding: 0 1rem;
    }

    .analyzer-form {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 2rem;
        border: 1px solid rgba(255,255,255,0.2);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    input[type="url"] {
        background: rgba(255,255,255,0.15);
        border: 2px solid rgba(255,255,255,0.3);
        color: white;
        border-radius: 12px;
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        transition: all var(--transition-speed) ease;
        width: 100%;
    }

    input[type="url"]:focus {
        background: rgba(255,255,255,0.2);
        border-color: rgba(255,255,255,0.5);
        box-shadow: 0 0 15px rgba(255,255,255,0.1);
    }

    input[type="url"]::placeholder {
        color: rgba(255,255,255,0.7);
    }

    .analyze-button {
        background: white;
        color: var(--gradient-start);
        border: none;
        padding: 1rem 2.5rem;
        font-size: 1.2rem;
        font-weight: 600;
        border-radius: 12px;
        cursor: pointer;
        transition: all var(--transition-speed) ease;
        width: 100%;
    }

    .analyze-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        background: var(--text-light);
    }

    .results-card {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: var(--card-shadow);
        margin-top: 4rem;
    }

    .card-header {
        background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        color: white;
        padding: 1.5rem 2rem;
    }

    .profile-section {
        background: white;
        border-radius: 15px;
        padding: 2.5rem;
        margin-bottom: 2.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .stat-box {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all var(--transition-speed) ease;
    }

    .stat-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }

    .stat-number {
        font-size: 2.2rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 0.5rem 0;
    }

    .grant-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        transition: all var(--transition-speed) ease;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .grant-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 25px rgba(0,0,0,0.1);
    }

    .btn {
        border-radius: 10px;
        padding: 0.8rem 1.5rem;
        font-weight: 600;
        transition: all var(--transition-speed) ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        border: none;
    }

    .btn-outline-primary {
        border: 2px solid var(--gradient-start);
        color: var(--gradient-start);
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .feature-box, .grant-card, .stat-box {
        animation: fadeIn 0.6s ease-out forwards;
    }

    .alert {
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin-bottom: 2rem;
        border: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="analyzer-hero">
    <div class="analyzer-form-wrapper">
        <h1>Website Analyzer</h1>
        <p class="subtitle">Enter your business website URL for automatic analysis</p>
        
        {% if error %}
        <div class="alert alert-danger" style="max-width:700px; margin:2rem auto 0 auto;">
            {{ error }}
        </div>
        {% endif %}
        
        <form method="POST" action="{{ url_for('analyzer') }}" class="analyzer-form">
            <div class="form-group">
                <label for="website_url">Website URL</label>
                <input type="url" name="website_url" id="website_url" 
                       placeholder="e.g., https://www.yourbusiness.com"
                       required>
            </div>
            <button type="submit" class="analyze-button" name="action" value="analyze">Analyze Website</button>
        </form>
    </div>
</div>

{% if editable_result %}
<div class="container" style="max-width: 700px; margin-top: -3rem; position: relative; z-index: 2;">
    <div class="feature-box mb-4" style="box-shadow: 0 8px 32px rgba(44,62,80,0.08);">
        <h2 class="mb-3" style="color: var(--primary-color);">Analyzer Result</h2>
        <p class="text-muted mb-4">This is the business profile generated by the AI analyzer. You can use it as-is or click Edit to make changes before searching for grants.</p>
        <form method="POST">
            <div class="row">
                <div class="col-md-6 mb-2"><strong>Business Industry:</strong> {{ editable_result.business_sector }}</div>
                <div class="col-md-6 mb-2"><strong>Business Size:</strong> {{ editable_result.company_size }}</div>
                <div class="col-md-6 mb-2"><strong>Funding Purpose:</strong> {{ editable_result.funding_purpose }}</div>
                <div class="col-md-6 mb-2"><strong>Amount Needed:</strong> {{ editable_result.preferred_amount }}</div>
                <div class="col-md-12 mb-2"><strong>Region:</strong> {{ editable_result.location }}</div>
            </div>
            <div class="d-flex justify-content-between mt-4">
                <button type="submit" name="action" value="match" class="btn btn-success">
                    <i class="fas fa-search"></i> Match Grants
                </button>
                <button type="submit" name="action" value="show_edit" class="btn btn-outline-primary">
                    <i class="fas fa-edit"></i> Edit
                </button>
            </div>
            {% for key, value in editable_result.items() %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endfor %}
        </form>
    </div>
</div>
{% endif %}

{% if show_editable_form %}
<div class="container" style="max-width: 700px; margin-top: 1rem; position: relative; z-index: 2;">
    <div class="feature-box" style="box-shadow: 0 8px 32px rgba(44,62,80,0.08);">
        <h2 class="mb-3" style="color: var(--primary-color);">Edit Analysis Result</h2>
        <p class="text-muted mb-4">Review and update your business profile before searching for matching grants.</p>
        <form method="POST">
            <div class="row">
                <div class="form-group col-md-6 mb-3">
                    <label for="business_sector">Business Industry</label>
                    <select id="business_sector" name="business_sector" class="form-control" required>
                        <option value="">Select your industry</option>
                        {% for industry in business_industries %}
                        <option value="{{ industry }}" {% if editable_result.business_sector == industry %}selected{% endif %}>{{ industry }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-6 mb-3">
                    <label for="company_size">Business Size</label>
                    <select id="company_size" name="company_size" class="form-control" required>
                        <option value="">Select your business size</option>
                        {% for size in business_sizes %}
                        <option value="{{ size }}" {% if editable_result.company_size == size %}selected{% endif %}>{{ size }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-6 mb-3">
                    <label for="funding_purpose">Funding Purpose</label>
                    <select id="funding_purpose" name="funding_purpose" class="form-control" required>
                        <option value="">Select funding purpose</option>
                        {% for purpose in funding_purposes %}
                        <option value="{{ purpose }}" {% if editable_result.funding_purpose == purpose %}selected{% endif %}>{{ purpose }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-6 mb-3">
                    <label for="preferred_amount">Amount Needed</label>
                    <select id="preferred_amount" name="preferred_amount" class="form-control" required>
                        <option value="">Select an amount range</option>
                        <option value="0-5000" {% if editable_result.preferred_amount == "0-5000" %}selected{% endif %}>Under £5,000</option>
                        <option value="5000-10000" {% if editable_result.preferred_amount == "5000-10000" %}selected{% endif %}>£5,000 - £10,000</option>
                        <option value="10000-25000" {% if editable_result.preferred_amount == "10000-25000" %}selected{% endif %}>£10,000 - £25,000</option>
                        <option value="25000-50000" {% if editable_result.preferred_amount == "25000-50000" %}selected{% endif %}>£25,000 - £50,000</option>
                        <option value="50000-100000" {% if editable_result.preferred_amount == "50000-100000" %}selected{% endif %}>£50,000 - £100,000</option>
                    </select>
                </div>
                <div class="form-group col-md-12 mb-3">
                    <label for="location">Region</label>
                    <input type="text" id="location" name="location" value="{{ editable_result.location }}" class="form-control" required>
                </div>
            </div>
            <button type="submit" name="action" value="edit" class="btn btn-primary mt-2 w-100">
                <i class="fas fa-search"></i> Save and Find Grants
            </button>
        </form>
    </div>
</div>
{% endif %}

<!-- Features Section -->
<div class="container mb-5">
    <div class="row">
        <div class="col-md-4">
            <div class="feature-box text-center">
                <div class="feature-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <h3>AI-Powered Analysis</h3>
                <p>Our advanced AI analyzes your website content to understand your business profile.</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="feature-box text-center">
                <div class="feature-icon">
                    <i class="fas fa-bullseye"></i>
                </div>
                <h3>Smart Matching</h3>
                <p>Get matched with relevant grants based on your business sector, size, and location.</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="feature-box text-center">
                <div class="feature-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>Easy Application</h3>
                <p>Apply for matching grants directly through our platform with AI-assisted applications.</p>
            </div>
        </div>
    </div>
</div>

{% if analysis_result %}
<!-- Analysis Results -->
<div class="container">
    <div class="results-card">
        <div class="card-header">
            <h2 class="h4 mb-0">Analysis Results</h2>
        </div>
        <div class="card-body">
            <!-- Business Profile -->
            <div class="profile-section">
                <h3 class="h5 mb-4">Business Profile</h3>
                <div class="row">
                    {% for key, value in analysis_result.items() %}
                    <div class="col-md-6 mb-3">
                        <div class="stat-box">
                            <h4 class="h6 text-muted mb-2">{{ key|replace('_', ' ')|title }}</h4>
                            <div class="stat-number">{{ value }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Matching Grants -->
            {% if matching_grants %}
            <div class="container" style="max-width: 700px; margin-top: 2rem;">
                <form method="GET" action="{{ url_for('search') }}" style="display:inline;">
                    <button type="submit" class="btn btn-outline-primary mb-3">
                        <i class="fas fa-search"></i> Modify Search (Go to Search Page)
                    </button>
                </form>
            </div>
            <h3 class="h5 mb-4">Matching Grants</h3>
            <form method="POST" action="{{ url_for('analyzer') }}" style="display:inline;">
                <input type="hidden" name="action" value="show_edit">
                <input type="hidden" name="business_sector" value="{{ editable_result.business_sector }}">
                <input type="hidden" name="company_size" value="{{ editable_result.company_size }}">
                <input type="hidden" name="funding_purpose" value="{{ editable_result.funding_purpose }}">
                <input type="hidden" name="preferred_amount" value="{{ editable_result.preferred_amount }}">
                <input type="hidden" name="location" value="{{ editable_result.location }}">
                <button type="submit" class="btn btn-outline-primary mb-3">
                    <i class="fas fa-edit"></i> Modify Search
                </button>
            </form>
            {% for grant in matching_grants %}
            <div class="grant-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="h6 mb-2">{{ grant.title }}</h4>
                        <p class="text-muted mb-2">
                            <i class="fas fa-building me-2"></i>{{ grant.funding_body }}
                            <span class="mx-2">•</span>
                            <i class="fas fa-pound-sign me-2"></i>{{ grant.amount_min }} - {{ grant.amount_max }}
                            <span class="mx-2">•</span>
                            <i class="fas fa-calendar me-2"></i>Deadline: {{ grant.deadline.strftime('%d %b %Y') }}
                        </p>
                        <p class="mb-0">{{ grant.description }}</p>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <button class="btn btn-outline-primary me-2" onclick="saveGrant({{ grant.id }})">
                            <i class="fas fa-bookmark me-1"></i>Save
                        </button>
                        <a href="{{ url_for('apply_for_grant', grant_id=grant.id) }}" class="btn btn-primary">
                            <i class="fas fa-pen me-1"></i>Apply
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>No matching grants found for your business profile.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Form validation
(function () {
    'use strict'
    var forms = document.querySelectorAll('.needs-validation')
    Array.prototype.slice.call(forms)
        .forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
})()

// Save grant function
function saveGrant(grantId) {
    fetch(`/save_grant/${grantId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Grant saved successfully!')
        } else {
            alert('Failed to save grant: ' + data.message)
        }
    })
    .catch(error => {
        console.error('Error:', error)
        alert('An error occurred while saving the grant')
    })
}
</script>
{% endblock %}
